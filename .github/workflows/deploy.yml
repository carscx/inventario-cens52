name: Deploy PHP (rsync) to CloudPanel

on:
  push:
    branches: ["main"] # despliega en cada push a main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_PATH: /home/carscx-inventario/htdocs/inventario.carscx.com

    steps:
      - name: ðŸ›°ï¸ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Escribir clave SSH privada
        shell: bash
        run: |
          set -euo pipefail
          umask 077
          mkdir -p ~/.ssh
          cat > ~/.ssh/id_ed25519 <<'KEY'
          ${{ secrets.SSH_PRIVATE_KEY }}
          KEY
          chmod 600 ~/.ssh/id_ed25519

      - name: ðŸ—ï¸ Registrar host conocido
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan -T 5 -H ${{ secrets.SSH_HOST }} -p ${{ secrets.SSH_PORT }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: ðŸ“¦ Preparar exclusiones de sincronizaciÃ³n
        shell: bash
        run: |
          set -euo pipefail
          cat > rsync-exclude.txt <<'EOF'
          .git*/
          .github/
          docker/
          README.md
          .env
          .env.*
          public/uploads/
          public/uploads/**
          EOF

      - name: ðŸ§¹ Prep remoto (crear carpetas compartidas si faltan)
        shell: bash
        run: |
          ssh -i ~/.ssh/id_ed25519 -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes -o PasswordAuthentication=no \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" '
              set -euo pipefail
              mkdir -p /home/carscx-inventario/htdocs/inventario.carscx.com/public/uploads/items
              mkdir -p /home/carscx-inventario/htdocs/inventario.carscx.com/.well-known/acme-challenge
            '

      - name: ðŸš€ Deploy con rsync (protegiendo .env y uploads)
        shell: bash
        run: |
          set -euo pipefail
          rsync -az --delete \
            --exclude=".env" \
            --exclude=".env.local" \
            --exclude="public/uploads/" \
            --exclude=".well-known/" \
            -e 'ssh -i ~/.ssh/id_ed25519 -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes -o PasswordAuthentication=no' \
            ./ "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/carscx-inventario/htdocs/inventario.carscx.com/"

      - name: ðŸ§° Post-deploy (carpetas, permisos, OPcache reset)
        shell: bash
        run: |
          set -euo pipefail
          ssh -i ~/.ssh/id_ed25519 -p ${{ secrets.SSH_PORT }} -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes -o PasswordAuthentication=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "set -euo pipefail
             DEPLOY_PATH='${{ env.DEPLOY_PATH }}'

             mkdir -p \"\$DEPLOY_PATH/public/uploads/items\"

             find \"\$DEPLOY_PATH\" -type d -exec chmod 755 {} \;
             find \"\$DEPLOY_PATH\" -type f -exec chmod 644 {} \;

             if command -v php >/dev/null 2>&1; then
               php -r 'if (function_exists(\"opcache_reset\")) { opcache_reset(); echo \"OPcache reset\n\"; }'
             fi"
